{"version":3,"file":"caprover-action.cjs.production.min.js","sources":["../src/caprover.ts","../src/index.ts"],"sourcesContent":["import * as core from '@actions/core';\nimport fetch from 'node-fetch'\n\ninterface CaproverApps {\n  appName: string\n  volumes: { volumeName: string }[]\n}\n\nexport class CapRover {\n  private url: string;\n  private tokenPromise: Promise<string>;\n\n  constructor(url: string, password: string) {\n    this.url = url;\n    this.tokenPromise = this.login(password);\n  }\n\n  private async login(password: string): Promise<string> {\n    try {\n      const response = await fetch(`http://${this.url}/api/v2/login`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\"password\": password}),\n      });\n      const data = await response.json() as { token: string };\n      core.setOutput('response', data);\n      return data.token;\n    } catch (error) {\n      core.setFailed(`Failed to create application: ${error.message}`);\n      throw error;\n    }\n  }\n\n  async getTokenOrError() {\n    const timeout = new Promise<string>((_, reject) =>\n      setTimeout(() => reject(new Error('Timeout waiting for token')), 2 * 60 * 1000) // 2 minutes\n    );\n    return await Promise.race([this.tokenPromise, timeout]);\n  }\n\n  async createApp(appName: string) {\n    try {\n      const token = await this.getTokenOrError();\n      const response = await fetch(`http://${this.url}/api/v2/user/apps/appDefinitions/register`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json', 'x-captain-auth': token },\n        body: JSON.stringify({\"appName\": appName, \"hasPersistentData\": true}),\n      });\n      const data = await response.json();\n      core.setOutput('response', data);\n    } catch (error) {\n      core.setFailed(`Failed to create application: ${error.message}`);\n    }\n  }\n\n  async deployApp(appName: string, imageTag: string, imageName?: string) {\n    try {\n      const token = await this.getTokenOrError();\n      const response = await fetch(`http://${this.url}/api/v2/user/apps/appData/${appName}`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json', 'x-captain-auth': token },\n        body: JSON.stringify({\n          \"schemaVersion\": 2,\n          \"imageName\": `${imageName || appName}:${imageTag}`\n      }),\n      });\n      const data = await response.json();\n      core.setOutput('response', data);\n    } catch (error) {\n      core.setFailed(`Failed to deploy application: ${error.message}`);\n    }\n  }\n\n  async getApp(appName: string) {\n    try {\n      const list = await this.getList();\n      const app = list.appDefinitions.find(app => app.appName === appName);\n      if (!app) {\n        throw new Error(`App ${appName} not found.`);\n      }\n      return app;\n    } catch (error) {\n      core.setFailed(`Failed to fetch app: ${error.message}`);\n    }\n    return null;\n  }\n\n  async getList(): Promise<{ appDefinitions: CaproverApps[] }> {\n    try {\n      const token = await this.getTokenOrError();\n      const response = await fetch(`http://${this.url}/api/v2/user/apps/appDefinitions`, {\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json', 'x-captain-auth': token },\n      });\n      const data = await response.json() as { appDefinitions: CaproverApps[] };\n      core.setOutput('response', data);\n      return data;\n    } catch (error) {\n      core.setFailed(`Failed to fetch list: ${error.message}`);\n    }\n    return { appDefinitions: [] }\n  }\n\n  async deleteApp(appName: string) {\n    try {\n      const token = await this.getTokenOrError();\n      const app = await this.getApp(appName)\n      const response = await fetch(`http://${this.url}/api/v2/user/apps/appDefinitions/delete`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json', 'x-captain-auth': token },\n        body: JSON.stringify({\n          appName: appName,\n          volumes: app?.volumes?.map(v => v.volumeName)\n        })\n      });\n      const data = await response.json();\n      core.setOutput('response', data);\n    } catch (error) {\n      core.setFailed(`Failed to delete application: ${error.message}`);\n    }\n  }\n}","import * as core from '@actions/core';\nimport { CapRover } from './caprover';\n\nasync function run() {\n  try {\n    const capRoverUrl = core.getInput('caprover_url', { required: true });\n    const password = core.getInput('caprover_password', { required: true });\n    const appName = core.getInput('app_name', { required: true });\n    const imageName = core.getInput('image_name', { required: false });\n    const imageTag = core.getInput('image_tag', { required: true });\n    const operation = core.getInput('operation', { required: true });\n\n    const caprover = new CapRover(capRoverUrl, password);\n\n    switch (operation) {\n      case 'create':\n        await caprover.createApp(appName);\n        break;\n      case 'deploy':\n        await caprover.deployApp(appName, imageTag, imageName);\n        break;\n      case 'cleanup':\n        await caprover.deleteApp(appName);\n        break;\n      default:\n        core.setFailed(`Invalid operation: ${operation}`);\n    }\n  } catch (error) {\n    core.setFailed(error?.message);\n  }\n}\n\nrun();\n"],"names":["CapRover","url","password","this","tokenPromise","login","_proto","prototype","_login","_asyncToGenerator","_regeneratorRuntime","mark","_callee","response","data","wrap","_context","prev","next","fetch","method","headers","Content-Type","body","JSON","stringify","sent","json","core","abrupt","token","t0","message","stop","_x","apply","arguments","getTokenOrError","_getTokenOrError","_callee2","timeout","_context2","Promise","_","reject","setTimeout","Error","race","createApp","_createApp","_callee3","appName","_context3","x-captain-auth","hasPersistentData","_x2","deployApp","_deployApp","_callee4","imageTag","imageName","_context4","schemaVersion","_x3","_x4","_x5","getApp","_getApp","_callee5","app","_context5","getList","appDefinitions","find","_x6","_getList","_callee6","_context6","deleteApp","_deleteApp","_callee7","_app$volumes","_context7","volumes","map","v","volumeName","_x7","_run","capRoverUrl","operation","caprover","required","t1","run"],"mappings":"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"}